<?php /** @var \Magento\Framework\Escaper $escaper */ ?>
<?php /** @var \Sapient\Worldpay\Block\Savedcard $block */ ?>

<?php  $_savecards = $block->getSavedCard(); ?>
<?= /* @noEscape */ $block->getChildHtml('info');?>

<?php if ($_savecards && count($_savecards)): ?>
    <div class="table-wrapper saved-cards">
        <table class="data table table-savedcard-items history" id="my-savecards-table">
            <caption class="table-caption"><?= /* @noEscape */ $escaper->escapeHtml(__('Saved Cards')) ?></caption>
            <thead>
                <tr>
                    <th scope="col" class="col card_type">
                        <?= /* @noEscape */ $block->getMyAccountLabels('AC2')
                            ?: $escaper->escapeHtml(__('Card Brand #'))?></th>
                    <th scope="col" class="col card_number">
                        <?= /* @noEscape */ $block->getMyAccountLabels('AC3')
                            ?: $escaper->escapeHtml(__('Card Number'))?></th>
                    <th scope="col" class="col card_holder_name">
                        <?= /* @noEscape */ $block->getCheckoutLabels('CO4')
                            ?: $escaper->escapeHtml(__('Card Holder Name'))?></th>
                    <th scope="col" class="col card_expiry_month">
                        <?= /* @noEscape */ $block->getMyAccountLabels('AC4')
                            ?: $escaper->escapeHtml(__('Card Expiry Month'))?></th>
                    <th scope="col" class="col card_expiry_year">
                        <?= /* @noEscape */ $block->getMyAccountLabels('AC5')
                            ?: $escaper->escapeHtml(__('Card Expiry Year'))?></th>
                    <th scope="col" colspan="2" class="col actions">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($_savecards as $_savecard): ?>
                    <tr>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC2')
                            ?: $escaper->escapeHtml(__('Card Brand #')) ?>" class="col card_type">
                            <?= /* @noEscape */ $_savecard->getCardBrand() ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC3')
                            ?: $escaper->escapeHtml(__('Card Number')) ?>" class="col card_number">
                            <?= /* @noEscape */ $_savecard->getCardNumber() ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getCheckoutLabels('CO4')
                            ?: $escaper->escapeHtml(__('Card Holder Name')) ?>" class="col card_holder_name">
                            <?= /* @noEscape */ $_savecard->getCardholderName() ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC4')
                            ?: $escaper->escapeHtml(__('Card Expiry Month')) ?>" class="col card_expiry_month">
                            <?= /* @noEscape */ $_savecard->getCardExpiryMonth() ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC5')
                            ?: $escaper->escapeHtml(__('Card Expiry Year')) ?>" class="col card_expiry_year">
                            <?= /* @noEscape */ $_savecard->getCardExpiryYear() ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC21')
                            ?: $escaper->escapeHtml(__('Actions')) ?>" class="col actions">
                            <?php if ($_savecard->getTokenCode() != '') { ?>
                            <a href="<?= /* @noEscape */ $block->getEditUrl($_savecard) ?>" class="action view">
                                <span>
                                    <?= /* @noEscape */ $block->getMyAccountLabels('AC6')
                                        ?: $escaper->escapeHtml(__('Update')) ?>
                                </span>
                            </a>
                            <?php } ?>
                        </td>
                        <td data-th="<?= /* @noEscape */ $block->getMyAccountLabels('AC21')
                            ?: $escaper->escapeHtml(__('Actions')) ?>" class="col actions">
                            <a href="javascript:void(0)" class="action delete"
                               data-delete-url="<?= /* @noEscape */ $block->getDeleteUrl($_savecard); ?>">
                                <span>
                                    <?= /* @noEscape */ $block->getMyAccountLabels('AC11')
                                        ?: $escaper->escapeHtml(__('Delete'))?>
                                </span>
                            </a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <script>
            require([
                'jquery',
                'Magento_Ui/js/modal/confirm'
            ], function($, confirm) {
                $(".action.delete").on("click", function(event) {
                    confirm({
                        title: "<?= /* @noEscape */ $block->getMyAccountLabels('AC11')
                            ?: $escaper->escapeHtml(__('Delete'))?>",
                        content: getMyAccountExceptions('IAVMA2')
                            || '<?= $escaper->escapeHtml(
                                    __("Are you sure you want to delete the card? <br>".
                                        "Once the card is deleted, subscriptions associated with it will be cancelled")
                                ) ?>',
                        actions: {
                            confirm: function() {
                                window.location.href = $(event.currentTarget).data('delete-url');
                            }
                        }
                    });
                });
            });
            function getMyAccountExceptions (exceptioncode){
                var data=window.MyAccountExceptions;
                var gendata=JSON.parse(data);
                for (var key in gendata) {
                    if (gendata.hasOwnProperty(key)) {
                        var cxData=gendata[key];
                    if(cxData['exception_code'].includes(exceptioncode)){
                        return cxData['exception_module_messages']?
                        cxData['exception_module_messages']:cxData['exception_messages'];
                    }
                    }
                }
            }
        </script>
    </div>
<?php else: ?>
    <div class="message info empty">
        <span>
            <?= /* @noEscape */ $block->getMyAccountLabels('AC30') ?: $escaper->escapeHtml(__('You have no Saved Card.')); ?>
        </span>
    </div>
<?php endif ?>
<div class="actions-toolbar">
    <div class="primary">
        <button type="button" role="button" id="add-card"
                title="<?= $block->getMyAccountLabels('IAVAC1') ?: $escaper->escapeHtmlAttr(__('Add New Card')) ?>"
                class="action primary add">
            <span>
                <?= /* @noEscape */ $block->getMyAccountLabels('IAVAC1') ?: $escaper->escapeHtml(__('Add New Card')) ?>
            </span>
        </button>
    </div>
</div>
<script type="text/x-magento-init">
    {
        ".page-main": {
            "newcard": {
                "addCard": "button#add-card",
                "addCardLocation": "<?= $escaper->escapeJs($escaper->escapeUrl($block->getAddNewCardLabel())) ?>",
                "isBilling": "<?= $escaper->escapeJs($escaper->escapeUrl($block->ifBillingAddressPresent())) ?>"
            }
        }
    }
</script>

